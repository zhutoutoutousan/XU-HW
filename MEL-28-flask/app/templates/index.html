<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Similarity Search</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
        }
        .product-card {
            height: 100%;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-4 {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .metadata {
            font-size: 0.875rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .metadata-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 0.375rem;
        }
        .find-similar-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
            transition: all 0.3s ease;
        }
        .find-similar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        .similarity-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .similarity-score {
            font-size: 0.875rem;
            color: #fff;
            background-color: #4CAF50;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
        }
        .feedback-btn {
            border: none;
            background: none;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .feedback-btn:hover {
            background-color: #f3f4f6;
        }
        .feedback-btn.active-up {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .feedback-btn.active-down {
            background-color: #fee2e2;
            color: #dc2626;
        }
        .feedback-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .feedback-score {
            font-size: 0.875rem;
            color: #6b7280;
        }
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
        }
        .loading-spinner {
            display: none;
            width: 3rem;
            height: 3rem;
        }
        .feedback-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .product-card:hover .feedback-controls {
            opacity: 1;
        }
        .floating-feedback-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #4f46e5;
            color: white;
            padding: 1rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 1000;
            border: none;
        }
        .floating-feedback-btn:hover {
            transform: scale(1.1);
            background: #4338ca;
        }
        .feedback-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        .feedback-modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .processing-step {
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        .processing-step.active {
            opacity: 1;
        }
        .processing-step .step-icon {
            background: transparent;
            transition: all 0.3s;
        }
        .processing-step.done .step-icon {
            background: #10B981;
            border-color: #10B981;
        }
        .processing-step.error .step-icon {
            background: #EF4444;
            border-color: #EF4444;
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
    </style>
</head>
<body class="min-h-screen py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-16" data-aos="fade-down">
            <h1 class="text-5xl font-bold text-gray-900 mb-6 tracking-tight">
                Product Similarity Search
            </h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto mb-8">
                Find similar products using AI-powered semantic search
            </p>
            
            <!-- Search Input -->
            <div class="max-w-2xl mx-auto">
                <div class="relative">
                    <input 
                        type="text" 
                        id="search-input"
                        class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
                        placeholder="Describe the product you're looking for..."
                    >
                    <button 
                        id="search-button"
                        class="absolute right-2 top-2 px-4 py-1.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors"
                    >
                        Search
                    </button>
                </div>
                <p class="mt-2 text-sm text-gray-500">
                    Example: "A comfortable office chair with good back support"
                </p>
            </div>
        </div>

        <!-- ... (keep existing error and loading sections) ... -->

        <!-- Search Results Section -->
        <div id="search-results-section" class="hidden mb-20">
            <h2 class="text-2xl font-bold text-gray-900 mb-4" data-aos="fade-right">
                Search Results
                <span id="search-query" class="text-lg font-normal text-gray-600 ml-2"></span>
            </h2>
            <div id="search-results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>


        <!-- Error Message -->
        <div id="error-message" class="hidden max-w-2xl mx-auto mb-8 bg-red-50 border border-red-200 rounded-lg">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-500 text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-spinner" class="hidden">
            <div class="flex flex-col items-center justify-center py-20">
                <div class="loading-pulse">
                    <svg class="w-16 h-16 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p class="mt-4 text-lg text-gray-600">Loading products...</p>
            </div>
        </div>

        <!-- Product Grid -->
        <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>

        <!-- Similar Products Section -->
        <div id="similar-products-section" class="hidden mt-20">
            <h2 class="text-3xl font-bold text-gray-900 mb-8" data-aos="fade-right">Similar Products</h2>
            <div id="similar-products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>

        <!-- Instructions -->
        <div id="instructions" class="mt-16 bg-white rounded-2xl shadow-xl p-8" data-aos="fade-up">
            <h3 class="text-2xl font-bold text-gray-900 mb-6">How it works</h3>
            <div class="space-y-6">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                        <span class="text-indigo-600 font-semibold">1</span>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-900">Browse Products</h4>
                        <p class="mt-1 text-gray-600">Explore our collection of products</p>
                    </div>
                </div>
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                        <span class="text-indigo-600 font-semibold">2</span>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-900">Find Similar Items</h4>
                        <p class="mt-1 text-gray-600">Click on "Find Similar Products" for items you like</p>
                    </div>
                </div>
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                        <span class="text-indigo-600 font-semibold">3</span>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-900">Discover Matches</h4>
                        <p class="mt-1 text-gray-600">Get AI-powered recommendations based on product descriptions</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <template id="product-card-template">
        <div class="group" data-aos="fade-up">
            <div class="product-card rounded-2xl overflow-hidden">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <span class="px-3 py-1 text-xs font-medium bg-indigo-100 text-indigo-800 rounded-full product-number">
                            Product #1
                        </span>
                        <div class="flex items-center gap-2">
                            <button class="feedback-btn upvote-btn p-1.5 rounded-full hover:bg-green-50 transition-colors" title="This product is helpful">
                                <i class="fas fa-thumbs-up text-green-600"></i>
                            </button>
                            <button class="feedback-btn downvote-btn p-1.5 rounded-full hover:bg-red-50 transition-colors" title="This product isn't helpful">
                                <i class="fas fa-thumbs-down text-red-600"></i>
                            </button>
                        </div>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-3 line-clamp-2 product-title"></h3>
                    <p class="text-gray-600 mb-4 line-clamp-4 product-description"></p>
                    <div class="metadata mb-4">
                        <span class="metadata-item">
                            <i class="fas fa-star text-yellow-400"></i>
                            <span class="product-stars"></span>
                        </span>
                        <span class="metadata-item">
                            <i class="fas fa-tag"></i>
                            <span class="product-price"></span>
                        </span>
                        <span class="text-xs text-gray-400">(Demo data)</span>
                    </div>
                    <div class="mt-3 text-sm">
                        <span class="text-gray-500">Feedback Score: </span>
                        <span class="feedback-score font-medium">0</span>
                    </div>
                    <button class="find-similar-btn w-full text-white font-medium px-4 py-2 rounded-lg transition-all">
                        Find Similar Products
                    </button>
                </div>
            </div>
        </div>
    </template>

    <template id="similar-product-card-template">
        <div class="group" data-aos="fade-up">
            <div class="product-card rounded-2xl overflow-hidden">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <span class="px-3 py-1 text-xs font-medium text-white similarity-badge rounded-full similarity-score">
                            95% Match
                        </span>
                        <div class="flex items-center gap-2">
                            <button class="feedback-btn upvote-btn p-1.5 rounded-full hover:bg-green-50 transition-colors" title="This result was helpful">
                                <i class="fas fa-thumbs-up text-green-600"></i>
                            </button>
                            <button class="feedback-btn downvote-btn p-1.5 rounded-full hover:bg-red-50 transition-colors" title="This result wasn't helpful">
                                <i class="fas fa-thumbs-down text-red-600"></i>
                            </button>
                        </div>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-3 line-clamp-2 product-title"></h3>
                    <p class="text-gray-600 mb-4 line-clamp-4 product-description"></p>
                    <div class="metadata">
                        <span class="metadata-item">
                            <i class="fas fa-star text-yellow-400"></i>
                            <span class="product-stars"></span>
                        </span>
                        <span class="metadata-item">
                            <i class="fas fa-tag"></i>
                            <span class="product-price"></span>
                        </span>
                        <span class="text-xs text-gray-400">(Demo data)</span>
                    </div>
                    <div class="mt-3 text-sm">
                        <span class="text-gray-500">Base Similarity: </span>
                        <span class="base-similarity font-medium"></span>
                        <span class="text-gray-500 ml-3">Feedback Score: </span>
                        <span class="feedback-score font-medium"></span>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Floating Feedback Button -->
    <button id="floating-feedback-btn" class="floating-feedback-btn" title="Give General Feedback">
        <i class="fas fa-comment-alt"></i>
    </button>

    <!-- General Feedback Modal -->
    <div id="feedback-modal" class="feedback-modal">
        <div class="modal-content">
            <button class="close-modal">Ã—</button>
            <h2 class="text-2xl font-bold mb-4">Give Us Your Feedback</h2>
            <form id="general-feedback-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rating</label>
                    <div class="flex gap-2">
                        <input type="radio" name="rating" value="1" id="rating-1" required>
                        <label for="rating-1">1</label>
                        <input type="radio" name="rating" value="2" id="rating-2">
                        <label for="rating-2">2</label>
                        <input type="radio" name="rating" value="3" id="rating-3">
                        <label for="rating-3">3</label>
                        <input type="radio" name="rating" value="4" id="rating-4">
                        <label for="rating-4">4</label>
                        <input type="radio" name="rating" value="5" id="rating-5">
                        <label for="rating-5">5</label>
                    </div>
                </div>
                <div>
                    <label for="feedback-comment" class="block text-sm font-medium text-gray-700 mb-1">Comments</label>
                    <textarea 
                        id="feedback-comment" 
                        name="comment" 
                        rows="4" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                        required
                    ></textarea>
                </div>
                <button 
                    type="submit" 
                    class="w-full bg-indigo-600 text-white font-medium px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors"
                >
                    Submit Feedback
                </button>
            </form>
        </div>
    </div>

    <!-- Processing Modal -->
    <div id="processing-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="processing-spinner mb-4">
                    <svg class="w-16 h-16 text-indigo-500 mx-auto animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold mb-4">Processing Feedback</h3>
                <div class="space-y-4 text-left">
                    <div class="processing-step" data-step="saving">
                        <div class="flex items-center">
                            <div class="step-icon w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3">
                                <i class="fas fa-check text-white"></i>
                            </div>
                            <span class="step-text">Saving feedback data...</span>
                        </div>
                    </div>
                    <div class="processing-step" data-step="updating">
                        <div class="flex items-center">
                            <div class="step-icon w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3">
                                <i class="fas fa-check text-white"></i>
                            </div>
                            <span class="step-text">Updating similarity model...</span>
                        </div>
                    </div>
                    <div class="processing-step" data-step="recomputing">
                        <div class="flex items-center">
                            <div class="step-icon w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3">
                                <i class="fas fa-check text-white"></i>
                            </div>
                            <span class="step-text">Recomputing embeddings...</span>
                        </div>
                    </div>
                    <div class="processing-step" data-step="finalizing">
                        <div class="flex items-center">
                            <div class="step-icon w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3">
                                <i class="fas fa-check text-white"></i>
                            </div>
                            <span class="step-text">Finalizing changes...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            once: true
        });

        // DOM Elements
        const productGrid = document.getElementById('product-grid');
        const similarProductsSection = document.getElementById('similar-products-section');
        const similarProductsGrid = document.getElementById('similar-products-grid');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const instructions = document.getElementById('instructions');

        // Templates
        const productCardTemplate = document.getElementById('product-card-template');
        const similarProductCardTemplate = document.getElementById('similar-product-card-template');

        // Pagination state
        let currentPage = 1;
        let totalPages = 1;
        let isLoading = false;

        // Show/hide loading spinner
        function setLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            if (isLoading) {
                errorMessage.classList.add('hidden');
            }
        }

        // Show error message
        function showError(message) {
            const errorElement = errorMessage.querySelector('p');
            errorElement.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Create pagination controls
        function createPaginationControls() {
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'flex justify-center items-center gap-4 mt-8 mb-12';
            
            const prevButton = document.createElement('button');
            prevButton.className = 'px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed';
            prevButton.textContent = 'Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    fetchProducts();
                }
            };
            
            const pageInfo = document.createElement('span');
            pageInfo.className = 'text-sm text-gray-700';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            const nextButton = document.createElement('button');
            nextButton.className = 'px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed';
            nextButton.textContent = 'Next';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    fetchProducts();
                }
            };
            
            paginationDiv.appendChild(prevButton);
            paginationDiv.appendChild(pageInfo);
            paginationDiv.appendChild(nextButton);
            
            return paginationDiv;
        }

        // Create product card with feedback
        function createProductCard(product, index, template) {
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('.group');
            
            // Common feedback setup for both templates
            const upvoteBtn = card.querySelector('.upvote-btn');
            const downvoteBtn = card.querySelector('.downvote-btn');
            const feedbackScoreElem = card.querySelector('.feedback-score');
            
            if (upvoteBtn && downvoteBtn) {
                upvoteBtn.addEventListener('click', () => 
                    handleFeedback(product, 'up', upvoteBtn, downvoteBtn));
                downvoteBtn.addEventListener('click', () => 
                    handleFeedback(product, 'down', upvoteBtn, downvoteBtn));
            }
            
            if (feedbackScoreElem) {
                feedbackScoreElem.textContent = product.feedback_score || '0';
            }

            if (template === productCardTemplate) {
                card.querySelector('.product-number').textContent = `Product #${index + 1}`;
                const findSimilarBtn = card.querySelector('.find-similar-btn');
                findSimilarBtn.addEventListener('click', () => handleProductSelect(product, index));
            } else {
                const similarityScore = (product.similarity_score * 100).toFixed(1);
                card.querySelector('.similarity-score').textContent = `${similarityScore}% Match`;
                
                // Add base similarity for similar products view
                if (card.querySelector('.base-similarity')) {
                    card.querySelector('.base-similarity').textContent = 
                        `${(product.base_similarity * 100).toFixed(1)}%`;
                }
            }

            card.querySelector('.product-title').textContent = product.title;
            card.querySelector('.product-description').textContent = product.description;
            card.querySelector('.product-stars').textContent = product.stars;
            card.querySelector('.product-price').textContent = `$${product.price}`;

            return clone;
        }

        // Handle product selection
        async function handleProductSelect(product, index) {
            try {
                setLoading(true);
                const response = await fetch(`/api/similar-products/${product.id}`);
                if (!response.ok) throw new Error('Failed to fetch similar products');
                
                const data = await response.json();
                
                similarProductsGrid.innerHTML = '';
                data.similar_products.forEach((product, idx) => {
                    const card = createProductCard(product, idx, similarProductCardTemplate);
                    similarProductsGrid.appendChild(card);
                });
                
                similarProductsSection.classList.remove('hidden');
                similarProductsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                AOS.refresh();
            } catch (err) {
                showError('Failed to fetch similar products');
                console.error(err);
            } finally {
                setLoading(false);
            }
        }

        // Process feedback steps with animation
        async function processSteps() {
            const processingModal = document.getElementById('processing-modal');
            const steps = processingModal.querySelectorAll('.processing-step');
            
            processingModal.style.display = 'flex';
            
            // Reset all steps
            steps.forEach(step => {
                step.classList.remove('done', 'error', 'active');
            });
            
            // Step timings
            const stepTimings = {
                'saving': 500,
                'updating': 1000,
                'recomputing': 1000,
                'finalizing': 500
            };
            
            // Process each step
            for (const step of steps) {
                const stepName = step.getAttribute('data-step');
                step.classList.add('active');
                
                try {
                    // Wait for the step timing
                    await new Promise(resolve => setTimeout(resolve, stepTimings[stepName]));
                    
                    // Mark step as done
                    step.classList.remove('active');
                    step.classList.add('done');
                } catch (error) {
                    step.classList.remove('active');
                    step.classList.add('error');
                    console.error(`Error in step ${stepName}:`, error);
                    throw error;
                }
            }
            
            // Wait a moment before closing
            await new Promise(resolve => setTimeout(resolve, 1000));
            processingModal.style.display = 'none';
            
            // Refresh the page to show updated recommendations
            window.location.reload();
        }

        // Handle feedback submission
        async function handleFeedback(product, vote, upvoteBtn, downvoteBtn) {
            try {
                // Disable both buttons during submission
                upvoteBtn.disabled = true;
                downvoteBtn.disabled = true;
                
                // Store current feedback for processing
                currentFeedbackType = 'product';
                currentProductId = product.id;
                currentVote = vote;
                currentRating = null;
                currentComment = null;

                // Submit feedback and process it
                const response = await fetch('/api/feedback/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'product',
                        productId: product.id,
                        vote: vote,
                        query: lastSearchQuery || ''  // Store the query that led to this result
                    }),
                });

                if (!response.ok) throw new Error('Failed to submit feedback');
                
                // Visual feedback
                upvoteBtn.classList.toggle('bg-green-50', vote === 'up');
                downvoteBtn.classList.toggle('bg-red-50', vote === 'down');
                
                // Update feedback score display
                const scoreElem = upvoteBtn.closest('.group').querySelector('.feedback-score');
                if (scoreElem) {
                    const currentScore = parseInt(scoreElem.textContent) || 0;
                    scoreElem.textContent = currentScore + (vote === 'up' ? 1 : -1);
                }
                
                // Show processing steps
                await processSteps();
                
            } catch (err) {
                console.error('Error submitting feedback:', err);
                showToast('Failed to submit feedback', 'error');
            } finally {
                // Re-enable buttons
                upvoteBtn.disabled = false;
                downvoteBtn.disabled = false;
            }
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transform transition-transform duration-300 translate-y-full ${
                type === 'success' ? 'bg-green-600' : 'bg-red-600'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateY(0)';
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateY(full)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Store feedback state
        let lastSearchQuery = '';
        let currentFeedbackType = null;
        let currentProductId = null;
        let currentVote = null;
        let currentRating = null;
        let currentComment = null;

        // Fetch products
        async function fetchProducts() {
            if (isLoading) return;
            
            try {
                setLoading(true);
                isLoading = true;
                
                const response = await fetch(`/api/products?page=${currentPage}&per_page=12`);
                if (!response.ok) throw new Error('Failed to fetch products');
                
                const data = await response.json();
                
                if (!data.products || data.products.length === 0) {
                    instructions.classList.remove('hidden');
                    return;
                }
                
                totalPages = data.pagination.total_pages;
                currentPage = data.pagination.current_page;
                
                productGrid.innerHTML = '';
                data.products.forEach((product, index) => {
                    const card = createProductCard(product, index, productCardTemplate);
                    productGrid.appendChild(card);
                });
                
                const existingPagination = document.querySelector('.pagination-controls');
                if (existingPagination) {
                    existingPagination.remove();
                }
                const paginationControls = createPaginationControls();
                paginationControls.className += ' pagination-controls';
                productGrid.after(paginationControls);
                
                instructions.classList.add('hidden');
                
                AOS.refresh();
            } catch (err) {
                showError('Failed to fetch products');
                console.error(err);
            } finally {
                setLoading(false);
                isLoading = false;
            }
        }

        // Add new DOM Elements
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchResultsSection = document.getElementById('search-results-section');
        const searchResultsGrid = document.getElementById('search-results-grid');
        const searchQueryDisplay = document.getElementById('search-query');

        // Add search functionality
        async function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                showError('Please enter a search query');
                return;
            }

            try {
                setLoading(true);
                lastSearchQuery = query;  // Store the query
                
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query }),
                });

                if (!response.ok) throw new Error('Failed to search products');
                
                const data = await response.json();
                
                // Clear and populate search results
                searchResultsGrid.innerHTML = '';
                data.products.forEach((product, idx) => {
                    const card = createProductCard(product, idx, similarProductCardTemplate);
                    searchResultsGrid.appendChild(card);
                });
                
                // Update search query display
                searchQueryDisplay.textContent = `for "${data.query}"`;
                
                // Show search results section
                searchResultsSection.classList.remove('hidden');
                searchResultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Hide product grid and similar products sections
                productGrid.classList.add('hidden');
                similarProductsSection.classList.add('hidden');
                
                // Refresh animations
                AOS.refresh();
            } catch (err) {
                showError('Failed to search products');
                console.error(err);
            } finally {
                setLoading(false);
            }
        }

        // Add event listeners for search
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });

        // Modify fetchProducts to show product grid and hide search results
        const originalFetchProducts = fetchProducts;
        fetchProducts = async function() {
            await originalFetchProducts();
            productGrid.classList.remove('hidden');
            searchResultsSection.classList.add('hidden');
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', fetchProducts);

        // General Feedback Modal Functionality
        const floatingFeedbackBtn = document.getElementById('floating-feedback-btn');
        const feedbackModal = document.getElementById('feedback-modal');
        const closeModalBtn = document.querySelector('.close-modal');
        const generalFeedbackForm = document.getElementById('general-feedback-form');

        floatingFeedbackBtn.addEventListener('click', () => {
            feedbackModal.classList.add('active');
        });

        closeModalBtn.addEventListener('click', () => {
            feedbackModal.classList.remove('active');
        });

        feedbackModal.addEventListener('click', (e) => {
            if (e.target === feedbackModal) {
                feedbackModal.classList.remove('active');
            }
        });

        generalFeedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const rating = formData.get('rating');
            const comment = formData.get('comment');
            
            try {
                // Store current feedback for processing
                currentFeedbackType = 'general';
                currentRating = parseInt(rating);
                currentComment = comment;
                currentProductId = null;
                currentVote = null;

                const response = await fetch('/api/feedback/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'general',
                        rating: currentRating,
                        comment: currentComment,
                        query: lastSearchQuery || ''
                    }),
                });

                if (!response.ok) throw new Error('Failed to submit feedback');
                
                feedbackModal.classList.remove('active');
                generalFeedbackForm.reset();
                
                // Show processing steps
                await processSteps();
            } catch (err) {
                console.error('Error submitting feedback:', err);
                showToast('Failed to submit feedback', 'error');
            }
        });
    </script>
</body>
</html>